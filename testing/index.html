<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <base target="_blank">
  <link rel="stylesheet" href="https://unpkg.com/purecss@2.0.6/build/pure-min.css" integrity="sha384-Uu6IeWbM+gzNVXJcM9XV3SohHtmWE+3VGi496jvgX1jyvDTXfdK+rfZc8C1Aehk5" crossorigin="anonymous">
  <link rel="stylesheet" href="https://unpkg.com/purecss@2.0.6/build/grids-responsive-min.css">
  <title>Test page</title>
  <script src="../js/html-include.js"></script>
  <link rel="stylesheet" href="../css/general.css">
  <link rel="icon" type="image/png" href="/favicon.png" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/3.0.3/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/svg2pdf.js@2.6.0/dist/svg2pdf.umd.min.js"></script> 
  <style>
  h3 {
    margin-top: 0.5em;
	margin-bottom: 0;
	font-weight: normal;
	font-size: 150%;
	font-family: 'Century Gothic', CenturyGothic, AppleGothic, sans-serif;
  }
  </style>
</head>

<body>
  <main>
    <div id="header" data-include="https://robbieandrew.github.io/inc/header.html"><p>&nbsp;</p></div>

	<h1>Testing</h1>
	<button id="updateSVGsBtn" class="discreet-btn" onclick="reloadSVGs()">Update SVGs</button>
    <div id="imageContainer" class="pure-g">
    </div>

	
    <div id="header" data-include="https://robbieandrew.github.io/inc/header.html"><p>&nbsp;</p></div>
  </main>

<script src="../js/svg-metadata.js"></script>
<script src="../js/findDataFiles.js"></script>
<script src="../js/downloadSVGasPNG.js"></script>
<script src="../js/svg-handler.js"></script>

<script>
/* parseCSVForImageOrder
   Parses the web_lookup.csv content to create a list of ordered objects,
   each containing the filename (with .svg) and its corresponding title.
*/
function parseCSVForImageOrder(csvContent) {
  const lines = csvContent.trim().split('\n');
  if (lines.length < 2) {
    console.error("CSV content is empty or only has a header.");
    return { fileOrder: [], imageOrderMap: new Map() };
  }

  // Helper to split a CSV line, handling quotes
  const splitLine = (line) => line.split(',').map(col => col.replace(/"/g, '').trim());
    
  // 1. Determine the required column indices from the header row
  const header = splitLine(lines[0]);
  const newFilenameIndex = header.indexOf("New Filename");
  const titleIndex = header.indexOf("Title"); // <-- New: Find 'Title' index

  if (newFilenameIndex === -1 || titleIndex === -1) {
    console.error("Required columns 'New Filename' or 'Title' not found in the CSV header.");
    return { fileOrder: [], imageOrderMap: new Map() };
  }

  const fileOrderData = []; // <-- New: Stores objects { filename, title }
  const imageOrderMap = new Map();
  
  // 2. Process data rows (starting from index 1)
  const dataLines = lines.slice(1);
  
  dataLines.forEach(line => {
    const columns = splitLine(line);

    // Ensure the row has enough columns for both indices
    if (columns.length > Math.max(newFilenameIndex, titleIndex)) {
      
      const newFilenameBase = columns[newFilenameIndex];
      const title = columns[titleIndex]; // <-- New: Get the title

      if (newFilenameBase) {
        const fullImageFilename = `${newFilenameBase}.svg`;

        if (!imageOrderMap.has(fullImageFilename)) {
          // Store an object with both the filename and the title
          fileOrderData.push({ 
            filename: fullImageFilename, 
            title: title || 'Untitled Figure' // Use a fallback title
          });
          imageOrderMap.set(fullImageFilename, true);
        }
      }
    }
  });

  return { fileOrderData, imageOrderMap }; // <-- Modified: returns fileOrderData
}
</script>
<script>
// ... findDataFiles.js (inside loadPageImagesFromCSV function)

async function loadPageImagesFromCSV(partialPath, csvContent) {
    const siteCode = null; 
    
    // 1. Get the desired order and titles from the CSV
    // CHANGE HERE: Destructure fileOrderData instead of fileOrder
    const { fileOrderData } = parseCSVForImageOrder(csvContent); 
    console.log("Desired image order and titles:", fileOrderData);

    // 2. Fetch all available images from GitHub
    const allImageUrls = await fetchGitHubImages(siteCode, partialPath);

    if (!allImageUrls || allImageUrls.length === 0) {
        displayErrorMessage(`No images found in folder ${partialPath}.`);
        return;
    }

    // 3. Sort the images AND store titles in a final structure
    const imageMetadataMap = new Map(); // Maps filename to its URL and title: { url, title }
    
    // Get the final folder name (e.g., 'img') to extract the simple filename from the URL
    const publicFolder = partialPath.replace(/\/$/, "").split("/").pop();
    
    // Populate the map with fetched images, keyed by simple filename (e.g., AtmosConc.svg)
    allImageUrls.forEach(url => {
        const filename = url.replace(`${publicFolder}/`, '');
        imageMetadataMap.set(filename, { url, title: null }); // Title is null initially
    });

    const finalSortedUrlsWithTitles = []; // <-- New structure: list of {url, title} objects

    // a) Add images listed in the CSV in the correct order
    fileOrderData.forEach(item => { // item is { filename, title }
        const metadata = imageMetadataMap.get(item.filename);
        if (metadata) {
            // Found a match: store URL and the title from the CSV
            finalSortedUrlsWithTitles.push({ url: metadata.url, title: item.title }); 
            imageMetadataMap.delete(item.filename); // Remove from map
        }
    });

    // b) Add remaining images (not listed in CSV) to the end
    const remainingFilenames = Array.from(imageMetadataMap.keys()).sort();
    
    remainingFilenames.forEach(filename => {
        const metadata = imageMetadataMap.get(filename);
        // Add remaining images with a default title
        finalSortedUrlsWithTitles.push({ url: metadata.url, title: `Unlisted Image: ${filename}` });
    });
    
    console.log("Final sorted image data:", finalSortedUrlsWithTitles);

    // 4. Display the sorted images
    // We need to pass the full list of objects to displayImages, not just a list of URLs
    const imageData = { [siteCode]: finalSortedUrlsWithTitles };
    // We will update displayImages to understand this new structure
    displayImages(siteCode, imageData); 
}
</script>

<script>
/**
 * Fetches the raw text content of a CSV file.
 * @param {string} csvFilePath - The relative path to the CSV file (e.g., 'web_lookup.csv').
 * @returns {Promise<string|null>} The raw CSV content as a string, or null on error.
 */
async function fetchCSVContent(csvFilePath) {
    try {
        const response = await fetch(csvFilePath);
        if (!response.ok) {
            console.error(`Failed to fetch CSV: ${response.status} ${response.statusText}`);
            return null;
        }
        return await response.text();
    } catch (error) {
        console.error("Fetch error for CSV file:", error);
        return null;
    }
}
async function initializeImagePage() {
    const csvContent = await fetchCSVContent('web_lookup.csv');

    if (csvContent) {
        await loadPageImagesFromCSV('testing/img', csvContent);
    } else {
        displayErrorMessage("Failed to load image configuration file.");
    }
}

// Call the initialization function when the page loads
initializeImagePage();
</script>

</body>

</html>
